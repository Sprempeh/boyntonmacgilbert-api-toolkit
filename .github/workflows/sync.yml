# =============================================================================
# Postman Collection Sync Workflow
# =============================================================================
#
# DEMO: When you change specs/payment-refund-api-openapi.yaml and push,
#       this workflow automatically updates your Postman collection!
#
# Triggers:
#   - Push to specs/*.yaml files â†’ Auto-sync
#   - Daily at 6 AM UTC â†’ Keep collections fresh  
#   - Manual trigger â†’ On-demand sync
#
# Setup:
#   1. Go to Settings â†’ Secrets â†’ Actions
#   2. Add: POSTMAN_API_KEY (your Postman API key)
#   3. Add: POSTMAN_WORKSPACE_ID (your workspace ID)
#
# =============================================================================

name: ğŸ”„ Sync Postman Collections

on:
  # Sync when specs change
  push:
    paths:
      - 'specs/**/*.yaml'
      - 'specs/**/*.yml'
    branches:
      - main
      - master

  # Daily sync at 6 AM UTC
  schedule:
    - cron: '0 6 * * *'

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      spec_file:
        description: 'Spec file to sync (or "all")'
        required: false
        default: 'all'
        type: string
      dry_run:
        description: 'Dry run (no changes made)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  sync:
    name: ğŸ“¤ Sync to Postman
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: ğŸ”‘ Validate secrets
        run: |
          if [ -z "${{ secrets.POSTMAN_API_KEY }}" ]; then
            echo "âŒ ERROR: POSTMAN_API_KEY secret is not set"
            echo "Go to Settings â†’ Secrets â†’ Actions to add it"
            exit 1
          fi
          if [ -z "${{ secrets.POSTMAN_WORKSPACE_ID }}" ]; then
            echo "âŒ ERROR: POSTMAN_WORKSPACE_ID secret is not set"
            echo "Go to Settings â†’ Secrets â†’ Actions to add it"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: ğŸ”„ Sync specs to Postman
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        run: |
          echo "============================================"
          echo "Starting Postman Sync"
          echo "============================================"
          echo ""
          echo "Trigger: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          
          SPEC_INPUT="${{ github.event.inputs.spec_file || 'all' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          
          if [ "$DRY_RUN" == "true" ]; then
            DRY_RUN_FLAG="--dry-run"
            echo "ğŸ§ª Mode: DRY RUN (no changes will be made)"
          else
            DRY_RUN_FLAG=""
            echo "ğŸš€ Mode: LIVE (changes will be applied)"
          fi
          echo ""
          
          if [ "$SPEC_INPUT" == "all" ]; then
            echo "ğŸ“ Syncing all spec files..."
            for spec_file in specs/*.yaml specs/*.yml; do
              if [ -f "$spec_file" ]; then
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸ“„ Processing: $spec_file"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                
                python scripts/postman_sync.py \
                  --spec "$spec_file" \
                  --workspace-id "${{ secrets.POSTMAN_WORKSPACE_ID }}" \
                  $DRY_RUN_FLAG
              fi
            done
          else
            echo "ğŸ“„ Syncing specific file: $SPEC_INPUT"
            
            if [ ! -f "$SPEC_INPUT" ]; then
              echo "âŒ ERROR: File not found: $SPEC_INPUT"
              exit 1
            fi
            
            python scripts/postman_sync.py \
              --spec "$SPEC_INPUT" \
              --workspace-id "${{ secrets.POSTMAN_WORKSPACE_ID }}" \
              $DRY_RUN_FLAG
          fi
          
          echo ""
          echo "============================================"
          echo "âœ… Sync Complete!"
          echo "============================================"

      - name: ğŸ“Š Upload sync summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-summary-${{ github.run_number }}
          path: sync-summary.json
          if-no-files-found: ignore
          retention-days: 30

  # Notify on failure
  notify-failure:
    name: ğŸš¨ Notify on Failure
    runs-on: ubuntu-latest
    needs: sync
    if: failure()

    steps:
      - name: ğŸ“§ Send failure notification
        run: |
          echo "âŒ Postman sync failed!"
          echo ""
          echo "Workflow: ${{ github.workflow }}"
          echo "Run: ${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "Check the logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
